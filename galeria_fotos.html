<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galería PetWise</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background-color: #0e1117; color: white; font-family: Arial, sans-serif; text-align: center; }
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
    gap: 1rem;
    margin-top: 2rem;
  }
  .pw-card {
    background-color: #1f2937;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    transition: transform 0.2s;
    padding-bottom: 10px;
  }
  .pw-card:hover { transform: translateY(-5px); }
  .pw-photo-wrap img {
    width: 100%;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.3s;
  }
  .pw-photo-wrap img:hover { transform: scale(1.05); }
  .usuario { font-size: 0.8rem; color: #ccc; margin-top: 5px; }
  .like-btn { cursor: pointer; color: #ff4d4d; font-weight: bold; margin-top: 5px; }
  #archivo, #correo, #subirFoto { margin: 10px; }

  /* LIGHTBOX */
  .lightbox-overlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center;
    visibility: hidden; opacity: 0; transition: opacity 0.3s; z-index: 9999;
  }
  .lightbox-overlay.active { visibility: visible; opacity: 1; }
  .lightbox-overlay img { max-width: 90%; max-height: 90%; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
  .lightbox-close { position: absolute; top: 20px; right: 30px; font-size: 2rem; cursor: pointer; }
</style>
</head>
<body>

<h1>Galería de Fotos (Beta)</h1>

<!-- Subida -->
<input type="text" id="correo" placeholder="Tu correo electrónico">
<input type="file" id="archivo" accept="image/*">
<button id="subirFoto">Subir Foto</button>

<!-- Galería -->
<div id="galeria" class="gallery-grid"></div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox-overlay">
  <span class="lightbox-close">&times;</span>
  <img src="" alt="Imagen ampliada">
</div>

<!-- Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const supabaseUrl = "https://tilsnvckijrgnjzylgof.supabase.co";
const supabaseKey = "TU_SUPABASE_KEY";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const archivoInput = document.getElementById("archivo");
const correoInput = document.getElementById("correo");
const subirBtn = document.getElementById("subirFoto");
const galeria = document.getElementById("galeria");

const lightbox = document.getElementById("lightbox");
const lightboxImg = lightbox.querySelector("img");
const lightboxClose = lightbox.querySelector(".lightbox-close");

// Cargar fotos con usuario y likes
async function cargarFotos() {
  galeria.innerHTML = "Cargando fotos...";

  let { data: fotos, error } = await supabase.from("likes").select("*");
  if (error) { galeria.innerHTML = "Error al cargar fotos"; return; }

  galeria.innerHTML = "";
  fotos.forEach(f => {
    const url = `${supabaseUrl}/storage/v1/object/public/fotos/${f.foto_nombre}`;
    const card = document.createElement("div");
    card.className = "pw-card";
    card.innerHTML = `
      <div class="usuario">${f.correo}</div>
      <div class="pw-photo-wrap"><img src="${url}" alt="foto"></div>
      <div class="like-btn">❤️ ${f.likes}</div>
    `;
    
    const likeBtn = card.querySelector(".like-btn");
    likeBtn.addEventListener("click", async () => {
      const correo = prompt("Ingresa tu correo para dar like:");
      if (!correo) return;
      if (f.usuarios_like && f.usuarios_like.includes(correo)) {
        alert("Ya diste like a esta foto");
        return;
      }

      const nuevosUsuarios = f.usuarios_like ? [...f.usuarios_like, correo] : [correo];
      const nuevosLikes = f.likes + 1;

      await supabase.from("likes").update({ likes: nuevosLikes, usuarios_like: nuevosUsuarios }).eq("id", f.id);
      cargarFotos();
    });

    card.querySelector("img").addEventListener("click", () => {
      lightboxImg.src = url;
      lightbox.classList.add("active");
    });

    galeria.appendChild(card);
  });
}

// Subir foto
subirBtn.addEventListener("click", async () => {
  const archivo = archivoInput.files[0];
  const correo = correoInput.value.trim();
  if (!archivo || !correo) { alert("Ingresa correo y archivo"); return; }

  const nombreArchivo = Date.now() + "-" + archivo.name;
  const { error: uploadError } = await supabase.storage.from("fotos").upload(nombreArchivo, archivo);
  if (uploadError) { alert("Error al subir: " + uploadError.message); return; }

  await supabase.from("likes").insert({
    foto_nombre: nombreArchivo,
    correo: correo,
    likes: 0,
    usuarios_like: []
  });

  archivoInput.value = "";
  correoInput.value = "";
  cargarFotos();
});

// Lightbox cerrar
lightboxClose.addEventListener("click", () => lightbox.classList.remove("active"));
lightbox.addEventListener("click", e => { if(e.target === lightbox) lightbox.classList.remove("active"); });

// Inicial
cargarFotos();
</script>
</body>
</html>
